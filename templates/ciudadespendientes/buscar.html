{% extends "base.html" %}

{% block content %}
<!-- Loading Overlay -->
<div id="loading-overlay"
  style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); z-index: 1050; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px);">
  <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem; border-width: 0.3em;">
    <span class="visually-hidden">Cargando...</span>
  </div>
  <h4 class="mt-4" style="color: #333; font-weight: bold;">Procesando polígonos y rutas...</h4>
  <p class="text-muted">Esto tomará unos segundos.</p>
</div>

<div id="content">
  <div class="container" style="padding: 20px 0;">
    <h3 class="mt-3"><b>Buscador de flujo según año y comuna</b></h3>
    <br>
    <form id="buscar-form" method="POST" action="/buscar/">
      {% csrf_token %}
      <div class="row">
        <div class="col-lg-3"></div>
        <div class="col-lg-6 text-start">
          <div class="form-container">
            <h5><label for="comunas">Comunas:</label></h5>
            <br>
            {% for ciudad in comunas %}
            <div class="form-check" style="margin-bottom: 5px;">
              <input type="checkbox" id="ciudad{{ forloop.counter }}" name="comunas" value="{{ ciudad }}"
                class="form-check-input comuna-checkbox" style="cursor: pointer;">
              <label class="form-check-label" for="ciudad{{ forloop.counter }}" style="cursor: pointer;">{{ ciudad|upper }}</label>
            </div>
            {% empty %}
            <p style="color: red;">No tienes permiso para visualización.</p>
            {% endfor %}
          </div>
        </div>
        <div class="col-lg-3">
          <div class="form-container">
            <h5><label for="periodo">Años:</label></h5>
            <br>
            {% for per in periodo %}
            <div class="form-check" style="margin-bottom: 5px;">
              <input type="checkbox" id="per{{ forloop.counter }}" name="periodo" value="{{ per }}"
                class="form-check-input periodo-checkbox" style="cursor: pointer;">
              <label class="form-check-label" for="per{{ forloop.counter }}" style="cursor: pointer;">{{ per }}</label>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      <br>
      <div style="text-align: center; padding-bottom: 30px;">
        <button type="submit" id="submit-btn" class="btn" disabled>VER MAPA</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('buscar-form');
    const submitBtn = document.getElementById('submit-btn');
    const comunaCheckboxes = document.querySelectorAll('.comuna-checkbox');
    const periodoCheckboxes = document.querySelectorAll('.periodo-checkbox');
    const loadingOverlay = document.getElementById('loading-overlay');

    function validateForm() {
      const hasComuna = Array.from(comunaCheckboxes).some(cb => cb.checked);
      const hasPeriodo = Array.from(periodoCheckboxes).some(cb => cb.checked);
      submitBtn.disabled = !(hasComuna && hasPeriodo);
    }

    comunaCheckboxes.forEach(cb => cb.addEventListener('change', validateForm));
    periodoCheckboxes.forEach(cb => cb.addEventListener('change', validateForm));

    form.addEventListener('submit', function () {
      if (!submitBtn.disabled) {
        loadingOverlay.style.display = 'flex';
      }
    });

    // Initial validation in case browser preserves checked inputs on refresh
    validateForm();
  });
</script>
{% endblock %}